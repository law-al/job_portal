// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  // url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  COMPANY
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum CompanyRole {
  ADMIN
  HR
  RECRUITER
  INTERVIEWER
  OTHER
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  TEMPORARY
  SEASONAL

  REMOTE
  HYBRID

  IN_OFFICE
  FREELANCE
  VOLUNTEER
  CONSULTANT
}

enum JobStatus {
  OPEN
  CLOSE
}

enum ExperienceLevel {
  INTERN
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
}

enum ApplicationStatus {
  APPLIED
  SCREENING
  SHORTLISTED
  INTERVIEW
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
}

enum UserCompanyStatus {
  ACTIVE
  SUSPENDED
  REMOVED
  BLOCKED
}

enum ActivityType {
  STAGE_CHANGED
  STATUS_CHANGED
  ASSIGNED
  UNASSIGNED
  NOTE_ADDED
  COMMENT
  EMAIL_SENT
  INTERVIEW_SCHEDULED
  INTERVIEW_UPDATED
  INTERVIEW_CANCELED
  FILE_UPLOADED
  PIPELINE_AUTOMATION
  APPLICATION_CREATED
}

model User {
  id                              String    @id @default(uuid()) @db.Uuid()
  provider                        String?
  providerId                      String?
  email                           String    @unique @db.VarChar(255)
  password                        String?   @db.VarChar(255)
  firstName                       String?   @db.VarChar(100)
  lastName                        String?   @db.VarChar(100)
  role                            UserRole  @default(USER)
  isVerified                      Boolean   @default(false)
  isActive                        Boolean   @default(true)
  isDeleted                       Boolean   @default(false)
  isEmailVerified                 Boolean   @default(false)
  isProfileCompleted              Boolean   @default(false)
  hasCompletedProfile             Boolean   @default(false)
  isPasswordChanged               Boolean   @default(false)
  passwordChangedAt               DateTime?
  passwordResetToken              String?   @db.VarChar(255)
  passwordResetTokenExpiresAt     DateTime?
  emailVerificationToken          String?   @db.VarChar(255)
  emailVerificationTokenExpiresAt DateTime?
  createdAt                       DateTime  @default(now())
  updatedAt                       DateTime  @updatedAt

  profile     Profile?
  company     UserCompany[]
  invitee     Invitation[]
  applicants  Application[]
  activities  ApplicationActivity[]

  @@unique([id])
  @@unique([providerId])
  @@index([email])
  @@map("users")
}

model Company {
  id          String   @id @default(uuid()) @db.Uuid()
  name        String   @db.VarChar(255)
  createdBy   String   @db.Uuid()
  description String   @db.Text
  website     String   @db.VarChar(255)
  address     String   @db.Text
  logo        String   @db.VarChar(255)
  isActive    Boolean  @default(true)
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  invitations  Invitation[]
  members      UserCompany[]
  jobs         Job[]
  applications Application[]

  @@unique([id])
  @@map("companies")
}

model UserCompany {
  id        String            @id @default(uuid()) @db.Uuid()
  role      CompanyRole       @default(OTHER)
  userId    String            @db.Uuid()
  companyId String            @db.Uuid()
  status    UserCompanyStatus @default(ACTIVE)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  assignedApplications Application[] @relation("AssignedApplications")

  @@unique([userId, companyId])
  @@map("user_companies")
}

model Invitation {
  id          String           @id @default(uuid()) @db.Uuid()
  email       String           @db.VarChar(255)
  token       String?          @unique @db.VarChar(255)
  hashedToken String?          @db.VarChar(255)
  role        CompanyRole
  companyId   String           @db.Uuid()
  invitedBy   String           @db.Uuid()
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime?
  acceptedAt  DateTime?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [invitedBy], references: [id])

  @@index([email, companyId])
  @@index([token])
  @@index([hashedToken])
  @@map("invitations")
}

model Job {
  id              String          @id @default(uuid()) @db.Uuid()
  companyId       String          @db.Uuid()
  slug            String          @db.VarChar(255)
  createdBy       String          @db.Uuid()
  title           String          @db.VarChar(255)
  description     String          @db.Text
  location        String          @db.VarChar(255)
  salary_range    String?         @db.VarChar(255)
  jobType         JobType         @default(FULL_TIME)
  status          JobStatus       @default(OPEN)
  experienceLevel ExperienceLevel @default(MID)
  slot            Int?
  isClosed        Boolean         @default(false)
  closedAt        DateTime?
  deadline        DateTime?
  isRemote        Boolean         @default(false)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  pipelineName    String?         @db.VarChar(255)

  company Company @relation(fields: [companyId], references: [id])

  applications   Application[]
  pipelineStages PipelineStage[]

  @@unique([slug])
  @@index([slug])
  @@map("jobs")
}

model PipelineStage {
  id    String @id @default(uuid()) @db.Uuid()
  jobId String @db.Uuid
  name  String @db.VarChar(255)
  order Int

  job          Job           @relation(fields: [jobId], references: [id])
  applications Application[]

  @@map("pipelineStages")
}

model Application {
  id              String            @id @default(uuid()) @db.Uuid()
  jobId           String            @db.Uuid()
  companyId       String            @db.Uuid()
  userId          String            @db.Uuid()
  firstName       String            @db.VarChar(100)
  lastName        String            @db.VarChar(100)
  email           String            @db.VarChar(255)
  phone           String            @db.VarChar(20)
  currentLocation String            @db.VarChar(255)
  linkedin        String?           @db.VarChar(255)
  coverLetter     String?           @db.Text
  expectedSalary  Int?
  portfolioUrl    String?
  resumeId        String?
  documentsIds    String[]
  status          ApplicationStatus @default(APPLIED)
  stageId         String?           @db.Uuid()
  assignedTo      String?           @db.Uuid()
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  job           Job                   @relation(fields: [jobId], references: [id])
  applicant     User                  @relation(fields: [userId], references: [id])
  company       Company               @relation(fields: [companyId], references: [id])
  pipelineStage PipelineStage?        @relation(fields: [stageId], references: [id])
  assigned      UserCompany?          @relation("AssignedApplications", fields: [assignedTo], references: [id])
  activities    ApplicationActivity[]

  @@index([id])
  @@index([jobId])
  @@index([userId])
  @@map("applications")
}

model ApplicationActivity {
  id String @id @default(uuid()) @db.Uuid()

  applicationId String  @db.Uuid()
  actorId       String? @db.Uuid()

  type     ActivityType
  message  String
  metadata Json?

  createdAt DateTime @default(now())

  application Application @relation(fields: [applicationId], references: [id])
  actor       User?       @relation(fields: [actorId], references: [id])

  @@index([applicationId])
  @@index([actorId])
  @@map("application_activities")
}

model Profile {
  id                  String          @id @default(uuid()) @db.Uuid()
  userId              String          @unique @db.Uuid()

  // Basic Information
  professionalHeadline String?         @db.VarChar(255)
  aboutMe             String?         @db.Text
  phone               String?         @db.VarChar(20)
  location            String?         @db.VarChar(255)
  linkedin            String?         @db.VarChar(255)
  github              String?         @db.VarChar(255)
  portfolioUrl        String?         @db.VarChar(255)
  resumeId            String[]        @db.VarChar(255)

  // Professional Details
  skills              String[]        // Array of skill strings
  preferredLocations  String[]        // Array of preferred location strings
  expectedSalary      Int?            // Expected salary range (min)
  expectedSalaryMax   Int?            // Expected salary range (max)

  // Experience (stored as JSON array)
  experiences         Json?           // Array of { title, company, location, startDate, endDate, description, isCurrent }

  // Education (stored as JSON array)
  education           Json?           // Array of { degree, institution, fieldOfStudy, startDate, endDate, isCurrent }

  // Certifications (stored as JSON array)
  certifications      Json?           // Array of { name, issuer, issueDate, expiryDate, credentialUrl }

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("profiles")
}
